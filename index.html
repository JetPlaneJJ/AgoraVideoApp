<!DOCTYPE html>
<!--
  Name: Jay Lin
  Last Updated: 05.21.2020
  Index file for Mystery Video App main page.
-->
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />
    <title>Mystery Video App</title>
    <link rel="stylesheet" href="./assets/common.css" />
    <link rel="stylesheet" href="css/style.css" />

    <!-- Scripts -->
    <script src="vendor/materialize.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://cdn.agora.io/sdk/release/AgoraRTCSDK-3.0.0.js"></script>
    <script src="assets/agora-rtm-sdk-1.2.2.js"></script>
    <!-- <script src="microsoft.cognitiveservices.speech.sdk.bundle.js"></script> -->
    <script src="assets/script.js"></script>

  </head>
  <!-- <speechsdkref> -->
  <!-- Speech SDK reference sdk. -->
  <script src="microsoft.cognitiveservices.speech.sdk.bundle.js"></script>
  <!-- </speechsdkref> -->
  <body class="agora-theme">
    <article class="navbar-fixed">
      <nav class="agora-navbar">
        <div class="nav-wrapper agora-primary-bg">
          <h5
            class="left-align"
            style="padding-top: 12px; text-align: left; font-weight: bold;"
          >
            Mystery Video App
          </h5>
        </div>
      </nav>
    </article>
    <!-- Main Content -->
    <div>
      <div class="card" style="margin-top: 20px;">
        <div class="row card-content" style="height: auto;">
          <div
            style="
              display: flex;
              justify-content: space-between;
              align-items: center;
            "
          >
            <span>
              <h5 id="display_name" style="font-size: 20px;">
                Current Display Name:
              </h5>
              <h5 id="channel_name" style="font-size: 20px;">
                Current Room Name:
              </h5>
            </span>
            <span>
              <form
                id="form"
                style="width: 200px;"
                onsubmit="onFormSubmit(); return false;"
              >
                <input
                  type="text"
                  id="cname"
                  placeholder="Enter Room Name to Join"
                />
              </form>
            </span>
            <span>
              <button
                type="submit"
                onclick="onFormSubmit(); return false;"
                class="btn btn-raised btn-primary waves-effect waves-light"
                id="join"
                style="margin-left: 10px; margin-right: 10px;"
              >
                JOIN
              </button>
              <button
                class="btn btn-raised btn-primary waves-effect waves-light"
                style="margin-left: 10px; margin-right: 10px;"
                id="leave"
              >
                LEAVE
              </button>
            </span>
          </div>
        </div>
      </div>
      <article style="display: flex;">
        <!-- local stream -->
        <div
          id="video"
          class="video-grid video-container"
        >
          <section class="video-view">
            <!-- TODO: fix this nickname functionality -->
            <div
              id="nickname_container_"
              class="agora-primary-bg"
              style="display: none;"
            >
              <h5 id="nickname_" class="left-align username-bar"></h5>
            </div>
            <div id="local_stream" class="video-placeholder"></div>
            <div id="local_video_info" class="video-profile hide"></div>
            <div id="video_autoplay_local" class="autoplay-fallback hide"></div>
          </section>

          <!-- add streams here, format =  Section > Div (h5), Div, Div... -->
        </div>
        <!-- Container for share screen button and chat log -->
        <section id="chatlog" style="height: 450px;">
          <button
            type="submit"
            onclick="shareScreen();"
            class="btn btn-raised btn-primary waves-effect waves-light"
            id="share"
            disabled
          >
            Share Your Screen
          </button>
          <div id="msg_log" style="overflow: scroll; height: 300px;">
            <!-- add messages here -->
          </div>
          <form
            name="message"
            action=""
            style="width: 370px; padding-left: 10px; padding-right: 10px;"
          >
            <input
              type="text"
              placeholder="Join a Room to Send Messages"
              id="usermsg"
              maxlength="50"
              onsubmit="sendMessage(); return false;"
              disabled
            />
            <div style="display: flex; justify-content: space-between;">
              <button
                class="btn btn-raised btn-primary waves-effect waves-light"
                type="submit"
                id="startSpeechToText"
                disabled
                style="padding-bottom: 10px;"
              >
                Enable Speech-To-Text
              </button>
              <!-- Send Message Button -->
              <button
                class="btn btn-raised btn-primary waves-effect waves-light"
                type="submit"
                id="submitmsg"
                onclick="sendMessage(); return false;"
                disabled
              >
                Send
              </button>
            </div>
          </form>
        </section>
      </article>
    </div>
  </body>
  <!-- <script type="module" src="assets/speech-to-text.js"></script> -->
  <script>
    // status fields and start button in UI
    var phraseDiv;
    var startRecognizeOnceAsyncButton;

    // subscription key and region for speech services.
    var subscriptionKey, serviceRegion;
    var authorizationToken;
    var SpeechSDK;
    var recognizer;

    document.addEventListener("DOMContentLoaded", function () {
      startB = document.getElementById("startSpeechToText");
      phraseDiv = document.getElementById("msg_log");

      startB.addEventListener("click", function () {
        startB.disabled = true;

        // if we got an authorization token, use the token. Otherwise use the provided subscription key
        let speechConfig;
        speechConfig = SpeechSDK.SpeechConfig.fromSubscription(
          'd3d083cb751b4fb2ba568ba373d4c43f', 
          'westus2');
        speechConfig.speechRecognitionLanguage = "en-US";
        let audioConfig  = SpeechSDK.AudioConfig.fromDefaultMicrophoneInput();
        recognizer = new SpeechSDK.SpeechRecognizer(speechConfig, audioConfig);

        recognizer.recognizeOnceAsync(
          function (result) {
            startB.disabled = false;
            phraseDiv.innerHTML += username + ": " + result.text;
            window.console.log(result.text);

            recognizer.close();
            recognizer = undefined;
          },
          function (err) {
            startRecognizeOnceAsyncButton.disabled = false;
            phraseDiv.innerHTML += err;
            window.console.log(err);

            recognizer.close();
            recognizer = undefined;
          });
      });

      if (!!window.SpeechSDK) {
        SpeechSDK = window.SpeechSDK;
        startB.disabled = false;

        // in case we have a function for getting an authorization token, call it.
        if (typeof RequestAuthorizationToken === "function") {
            RequestAuthorizationToken();
        }
      }
    });
  </script>
</html>
